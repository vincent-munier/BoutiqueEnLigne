<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
    http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

	<var name="Product" class="fr.umlv.m2.jee.persistence.product.Product" />
	<var name="DisplayProduct" class="fr.umlv.m2.jee.jsf.webflow.service.cart.DisplayProduct" />

	<on-start>
		<evaluate expression="defaultDisplayCartService.init()"></evaluate>
		<set name="flowScope.paymentMode" value="'Cheque'" type="java.lang.String" />
		<set name="flowScope.cbType" value="'visa'" type="java.lang.String" />

		<set name="flowScope.selectedAddress" value="'default Adress'"
			type="java.lang.String" />

		<evaluate expression="defaultDisplayProductService.init()"></evaluate>
		<evaluate expression="defaultDisplayProductService.getAllProduct()"
			result="flowScope.listProduct" result-type="dataModel"></evaluate>
		<!-- faire un test de role (client, utilisateur) est stockÃ© ds une var 
			a part pour retest dans la page -->
	</on-start>

	<view-state id="listProduct" view="listProduct.xhtml">

		<transition on="addCart" to="addCart">
			<set name="Product" value="flowScope.listProduct.selectedRow" />
		</transition>
		<transition on="viewCart" to="cart">
			<evaluate expression="defaultDisplayCartService.getAllProduct()"
				result="flowScope.listDisplayProduct" result-type="dataModel"></evaluate>
		</transition>

		<transition on="testPayment" to="paymentMode" />

	</view-state>


	<view-state id="newAddress" view="command/newAddress.xhtml">
		<transition on="back" to="command">
			<evaluate expression="defaultDisplayAddressService.getAddressesByClientId(0)"
				result="flowScope.listAddresses" result-type="dataModel"></evaluate>
		</transition>
	</view-state>

	<view-state id="command" view="command/availableAddress.xhtml">
		<transition on="viewCart" to="cart">
			<evaluate expression="defaultDisplayCartService.getAllProduct()"
				result="flowScope.listDisplayProduct" result-type="dataModel"></evaluate>
		</transition>
		<transition on="backPurchase" to="listProduct">
			<evaluate expression="defaultDisplayProductService.getAllProduct()"
				result="flowScope.listProduct" result-type="dataModel"></evaluate>
		</transition>
		<transition on="continueCommand" to="newAddress" />

	</view-state>

	<view-state id="cart" view="cart.xhtml" model="DisplayProduct">
		<binder>
			<binding property="ssid" required="true" />
			<binding property="lastName" required="true" />
			<binding property="firstName" required="true" />
			<binding property="birthday" required="true" />
			<binding property="death" required="true" />
		</binder>
		<transition on="continue" to="listProduct">
			<evaluate expression="defaultDisplayProductService.getAllProduct()"
				result="flowScope.listProduct" result-type="dataModel"></evaluate>
		</transition>
		<transition on="checkout" to="command">
			<evaluate expression="defaultDisplayAddressService.getAddressesByClientId(0)"
				result="flowScope.listAddresses" result-type="dataModel"></evaluate>
		</transition>
		<transition on="delCart" to="delCart">
			<set name="DisplayProduct" value="flowScope.listDisplayProduct.selectedRow" />
		</transition>
		<transition on="updateCart" to="updateCart">
			<set name="DisplayProduct" value="flowScope.listDisplayProduct.selectedRow" />
		</transition>
		<transition on="viewCart" to="cart">
			<evaluate expression="defaultDisplayCartService.getAllProduct()"
				result="flowScope.listDisplayProduct" result-type="dataModel"></evaluate>
		</transition>
	</view-state>

	<action-state id="addCart">
		<evaluate expression="defaultDisplayCartService.addProduct(Product)"></evaluate>
		<transition on="success" to="cart">
			<evaluate expression="defaultDisplayCartService.getAllProduct()"
				result="flowScope.listDisplayProduct" result-type="dataModel"></evaluate>
		</transition>
	</action-state>

	<action-state id="delCart">
		<evaluate expression="defaultDisplayCartService.delProduct(DisplayProduct)"></evaluate>
		<transition on="success" to="cart">
			<evaluate expression="defaultDisplayCartService.getAllProduct()"
				result="flowScope.listDisplayProduct" result-type="dataModel"></evaluate>
		</transition>

	</action-state>
	<view-state id="paymentMode" view="payment_choice.xhtml">
		<transition on="back" to="" />
		<transition on="continue" to="mode" />
	</view-state>

	<view-state id="mode" view="paymentMode.xhtml">
		<transition on="back" to="paymentMode" />
		<transition on="continue" to="" />
	</view-state>
</flow>
